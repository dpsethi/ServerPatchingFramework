<?xml version="1.0" encoding="UTF-8"?><record_update table="sysauto_script">
    <sysauto_script action="INSERT_OR_UPDATE">
        <active>true</active>
        <business_calendar/>
        <condition/>
        <conditional>false</conditional>
        <entered_time/>
        <name>SPF Process Active Records</name>
        <offset/>
        <offset_type>0</offset_type>
        <run_as display_value="">c1904f6937a7a64085862ab843990eb7</run_as>
        <run_as_tz/>
        <run_dayofmonth>1</run_dayofmonth>
        <run_dayofweek>1</run_dayofweek>
        <run_period/>
        <run_start>2021-03-13 18:50:42</run_start>
        <run_time>1970-01-01 05:30:00</run_time>
        <run_type>daily</run_type>
        <script><![CDATA[//script to process Active records from spf mapping table
var TABLE_NAME = "x_tdbf2_server_pat_spf";
var grActive = new GlideRecord(TABLE_NAME);
grActive.addQuery('active', true);
grActive.orderBy('number');
grActive.query();
gs.info('SPF - Total Active Records:' + grActive.getRowCount());
//loop thru all active records
while (grActive.next()) {
    //gather variables
	gs.info('dps - now processing record ' + grActive.number);
    var os = grActive.os_family;
    var dac = grActive.deployment_application_code;
    var vst = grActive.virtual_server_technology;
    var env = grActive.environment;
    var support = grActive.level_2_support_group;
    var loc = grActive.location;
    //get patch data
    var patchGroup = grActive.patching_team;
    var patchDays = grActive.patch_day_of_month;
    var patchStartTime = grActive.patch_start_time;

    //now find servers matching criteria
    var gr = new GlideRecord('cmdb_ci_server');
    var minOneFieldInQuery = "false";
    if (!env == '') {
        gr.addQuery('u_os_environment', env);
        minOneFieldInQuery = "true";
    }
    if (!dac == '') {
        gr.addQuery('u_deployment_application_code', dac);
        minOneFieldInQuery = "true";
    }
    if (!os == '') {
        gr.addQuery('u_os_family', os);
        minOneFieldInQuery = "true";
    }
    if (!loc == '') {
        gr.addQuery('location', loc);
        minOneFieldInQuery = "true";
    }
    if (!support == '') {
        gr.addQuery('u_support_group_l2', support);
        minOneFieldInQuery = "true";
    }
    if (!vst == '') {
        gr.addQuery('u_virtual_server_technology', vst);
        minOneFieldInQuery = "true";
    }

    gr.addQuery('asset.install_status', '!=', 7).addOrCondition('asset.install_status', ''); //exclude retired
    gr.addQuery('u_patch_data_source', '!=', 'Manual').addOrCondition('u_patch_data_source', ''); //exclude cis flagged as manual 
    if (minOneFieldInQuery == "true") {
        //process only if min one field is sent in quer
        gr.query();
        gr.setValue('u_os_patching_team', patchGroup);
        gr.setValue('u_patch_day_of_month', patchDays);
        gr.setValue('u_patch_start_time', patchStartTime);
        gr.updateMultiple();
	
		var strQry = gr.getEncodedQuery();
        var instanceURL = gs.getProperty('glide.servlet.uri');
        strQry = instanceURL + "cmdb_ci_server_list.do?sysparm_query=" + strQry;
        var hist = 'Records Updated: ' + gr.getRowCount() + '\n'; 
		hist = hist + 'URL: ' + strQry + '\n';
		hist = hist + 'Updated by Scheduled Job' + '\n';
		
		hist = hist + 'Patching team: ' + grActive.patching_team.name + '\n';
		hist = hist + 'Patch day of month: '+ patchDays + '\n';
		hist = hist + 'Patch start time: ' + patchStartTime + '\n';
		
		
    } else {
        gs.info(grActive.number + ";error encounterd; Minimum one field required; Encoded query=> " + gr.getEncodedQuery());
    }
    gs.info(grActive.number + " Encoded query is " + gr.getEncodedQuery());
    gs.info(grActive.number + ':Updated ' + gr.getRowCount());
	grActive.history = hist;
    grActive.update();
}]]></script>
        <sys_class_name>sysauto_script</sys_class_name>
        <sys_created_by>SETHID2-P3@TDBFG.com</sys_created_by>
        <sys_created_on>2021-03-13 18:54:30</sys_created_on>
        <sys_id>ff534a36db322090f578334239961938</sys_id>
        <sys_mod_count>12</sys_mod_count>
        <sys_name>SPF Process Active Records</sys_name>
        <sys_package display_value="Server Patching Framework" source="x_tdbf2_server_pat">02f952b7dba164507a2ff9d4e29619c5</sys_package>
        <sys_policy/>
        <sys_scope display_value="Server Patching Framework">02f952b7dba164507a2ff9d4e29619c5</sys_scope>
        <sys_update_name>sysauto_script_ff534a36db322090f578334239961938</sys_update_name>
        <sys_updated_by>SETHID2-P3@TDBFG.com</sys_updated_by>
        <sys_updated_on>2021-05-14 15:10:32</sys_updated_on>
        <time_zone/>
        <upgrade_safe>false</upgrade_safe>
    </sysauto_script>
</record_update>
